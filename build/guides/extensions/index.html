<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<link href="/stylesheets/site.css?1312603675" media="screen" rel="stylesheet" type="text/css">
<title>Middleman: Custom Extensions</title>
</head>
<body>
    <div id="frame">
      <div class="container">
        <aside><header><h1><a href="/">Middleman</a></h1>
            <h4>Hand-crafted frontend development</h4>
          </header><nav><ul>
<li><a href="/guides/getting-started">Getting Started</a></li>
              <li><a href="/guides/migrating">Migrating to Middleman 2.0</a></li>
              <li><a href="/guides/templates-layouts-partials">Templates, Layouts &amp; Partials</a></li>
              <li><a href="/guides/sass-and-compass">Sass and Compass</a></li>
              <li><a href="/guides/coffeescript-sprockets">CoffeeScript &amp; Sprockets</a></li>
              <li><a href="/guides/dynamic-pages">Dynamic Pages</a></li>
              <li><a href="/guides/pretty-urls">Pretty URLs</a></li>
              <li><a href="/guides/frontend-optimization">Frontend Optimization</a></li>
              <li><a href="/guides/individual-page-configuration">Individual Page Configuration</a></li>
              <li><a href="/guides/livereload">LiveReload</a></li>
              <li><a href="/guides/local-yaml-data">Local YAML Data</a></li>
              <li><a href="/guides/extensions">Custom Extensions</a></li>
              <li><a href="/guides/rack-middleware">Rack Middleware</a></li>
              <li class="div"><a href="/built-using-middleman">Sites Built Using Middleman</a></li>
            </ul></nav><footer><p>Â© 2011 <a href="http://awardwinningfjords.com">Thomas Reynolds</a>.<br>
            Middleman is open-source software licensed under the <a href="https://github.com/tdreyno/middleman/blob/master/LICENSE">MIT License</a>.</p> </footer></aside><article id="main" role="main"><h1>Custom Extensions</h1>

<p>Middleman extensions are Ruby classes which can hook into various points of the Middleman system, add new features and manipulate content.</p>

<p>The most basic extension looks like:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>All features must be namespaced under the <code>Middleman::Features</code> prefix. This module must be accessible to your <code>config.rb</code> file. Either define it directly in that file, or define it in another ruby file and <code>require</code> it in <code>config.rb</code></p>

<p>Finally, once your module is included, you must activate it in <code>config.rb</code>:</p>

<div class="highlight"><pre><span class="n">activate</span> <span class="ss">:my_feature</span>
</pre></div>


<p>The name of your feature is the lowercased and underscored version of the original <code>MyFeature</code> module name.</p>

<p>In the <code>MyFeature</code> extension, the registered method will be called as soon as the <code>activate</code> command is run. The <code>app</code> variable is a <code>Middleman::Base</code> class. Using this class, you can augment the Middleman environment.</p>

<h2>Setting variables</h2>

<p>The <code>Middleman::Base</code> class can be used to change settings (variables using the set command) in your extension.</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">set</span> <span class="ss">:css_dir</span><span class="p">,</span> <span class="s2">"lib/my/css"</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>You can also use this ability to create new settings which can be accessed later in your extension.</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">set</span> <span class="ss">:my_feature_interal_array</span><span class="p">,</span> <span class="sx">%w(one two three)</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<h2>Adding Methods to config.rb</h2>

<p>Methods available inside <code>config.rb</code> as simply class methods of <code>Middleman::Base</code>. Let's add a new method to be used in the <code>config.rb</code>:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">extend</span> <span class="no">ClassMethods</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">ClassMethods</span>
    <span class="k">def</span> <span class="nf">say_hello</span>
      <span class="nb">puts</span> <span class="s2">"Hello"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>By extending the <code>Middleman::Base</code> class, available as <code>app</code>, we've added a <code>say_hello</code> method to the environment which simply prints "Hello". Internally, these methods are used to build lists of paths and requests which will be processed later in the app.</p>

<h2>after_configuration Callback</h2>

<p>Sometimes you will want to wait until the <code>config.rb</code> has been parsed to run code. For example, if you rely on the <code>:css_dir</code> variable, you should wait until it has been set. For this, we'll use a callback:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">after_configuration</span> <span class="k">do</span>
        <span class="n">the_users_setting</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">css_dir</span>
        <span class="n">set</span> <span class="ss">:my_setting</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">the_users_setting</span><span class="si">}</span><span class="s2">_with_my_suffix"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<h3>Compass Callback</h3>

<p>Similarly, if you're extension relies on variable and settings within Compass to be ready, use the <code>compass_config</code> callback.</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">compass_config</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
        <span class="c1"># config is the Compass.configuration object</span>
        <span class="n">config</span><span class="o">.</span><span class="n">output_style</span> <span class="o">=</span> <span class="ss">:compact</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<h2>Adding Helpers</h2>

<p>Helpers are methods available inside your template. To add helper methods, we do the following:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">helpers</span> <span class="no">HelperMethods</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">HelperMethods</span>
    <span class="k">def</span> <span class="nf">make_a_link</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
      <span class="s2">"&lt;a href='</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">'&gt;</span><span class="si">#{</span><span class="n">text</span><span class="si">}</span><span class="s2">&lt;/a&gt;"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>Now, inside your templates, you will have access to a <code>make_a_link</code> method. Here's an example using an ERb template:</p>

<div class="highlight"><pre><span class="x">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="n">make_a_link</span><span class="p">(</span><span class="s2">"http://example.com"</span><span class="p">,</span> <span class="s2">"Click me"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x">&lt;/h1&gt;</span>
</pre></div>


<h2>Request Callback</h2>

<p>The request callback allows you to do processing before Middleman renders the page. This can be useful for returning data from another source, or failing early. The internal <code>:front_matter</code> extension uses this hook to parse YAML inside the template files before the templates are rendered.</p>

<p>Here's an example:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">before_processing</span> <span class="k">do</span>
        <span class="n">app</span><span class="o">.</span><span class="n">set</span> <span class="ss">:currently_requested_path</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">path_info</span>
        <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>The above sets the <code>:currently_requested_path</code> value at the beginning of each request. Notice the return value of "true." All blocks using <code>before_processing</code> must return either true or false. True allows the processing to continue after the callback in run. False halts the processing immediately. Internal extensions use this ability to set 404 headers on missing files and halt processing if they don't exist.</p>

<h2>build_reroute Callback</h2>

<p>During the build cycle, you can hook into any file which Middleman is intending to generate and either cancel that file creation or change internal build target.</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">build_reroute</span> <span class="k">do</span> <span class="o">|</span><span class="n">destination</span><span class="p">,</span> <span class="n">request_path</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">request_path</span> <span class="o">=~</span> <span class="sr">/my-most-hated-word/</span>
          <span class="c1"># Exceptions will cause the file to not be created</span>
          <span class="kp">throw</span>
        <span class="k">elsif</span> <span class="n">request_path</span> <span class="o">=~</span> <span class="sr">/my-safe-word/</span>
          <span class="c1"># False will allow the file to be create as normal</span>
          <span class="kp">false</span>
        <span class="k">else</span>
          <span class="c1"># Returning an array will change the destination</span>
          <span class="c1"># and source variables during the build.</span>
          <span class="o">[</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">"original"</span><span class="p">,</span> <span class="s2">"new"</span><span class="p">),</span>
            <span class="n">request_path</span>
          <span class="o">]</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<h2>after_build Callback</h2>

<p>This callback is used to execute code after the build process has finished. The <a href="https://github.com/tdreyno/middleman-smusher">middleman-smusher</a> extension uses this feature to compress all the images in the build folder after it has been build. It's also conceivable to integrate a deployment script after build.</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">after_build</span> <span class="k">do</span>
        <span class="sb">`my_deploy_script.sh`</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<h2>Sinatra</h2>

<p>The Middleman::Base class is an extension of Sinatra. Therefore the <code>app</code> variable also has access to Sinatra routes for additional customization:</p>

<div class="highlight"><pre><span class="k">module</span> <span class="nn">Middleman::Features::MyFeature</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="n">app</span><span class="o">.</span><span class="n">get</span> <span class="s2">"/hello"</span> <span class="k">do</span>
        <span class="s2">"World"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">alias</span> <span class="ss">:included</span> <span class="ss">:registered</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>The above will show a page with the contents "World" for all request to: </p>

<pre>http://localhost:4567/hello
</pre>

<p>Be aware, this only effects the Middleman preview server, not the built output.</p>
<footer><a href="https://github.com/tdreyno/middleman-guides/blob/master/source/guides/extensions.html.markdown">Fork and edit this guide on Github</a></footer></article>
</div>
    </div>
<script src="/javascripts/site.js?1312603674" type="text/javascript"></script><!-- Google Analytics --><script type="text/javascript">  var _gaq = _gaq || [];  _gaq.push(['_setAccount', 'UA-90027-21']);  _gaq.push(['_trackPageview']);  (function() {    var ga = document.createElement('script');    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';    ga.setAttribute('async', 'true');    document.documentElement.firstChild.appendChild(ga);  })();</script>
</body>
</html>
